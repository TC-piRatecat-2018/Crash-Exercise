---
title: "Downloading, Perform Preliminary Formatting and Storing Fatal Accident Reporting System (FARS) Data"
author: "Josh Roll - Oregon Department of Transportation (ODOT)"
email: josh.f.roll@odot.state.or.us
output: 
  html_document:
width: 99999
---

##Introduction
The Fatal Accident Reporting System (FARS) is a nationwide census of fatal traffic injuries recorded by the National Highway Transportation Safety Administration (NHTSA).  These data offer many insights into traffic safety conditions across the United States and are one of the longest, nationally available datasets available. 

These data span the years from 1975 up to nearly the present (as of this writing 2016).  These data cover many details including crashes, the vehicles and persons involved, among others.  But in order to construct lessons from these data they first neeed to be acquired and processed so they can be compiled for analysis.  

The script below is a small program that will allow users to download data from NHTSA's ftp site, perform some preliminary formatting and storing into smaller, R-native data objects.

###Load Libraries
```{r }
	library(foreign)
```

###Create Folder Structure to Store Data 
Create working folders (Be sure to have write access to any selected directories)

```{r}
	#Choose working directory
	#setwd(choose.dir())
	#Create folder structure
	#++++++++++++++++++++
  #Define the name you wish to fall the master directory
	Main_Dir <- "FARS_Test"
	#Create main directory 
	if(!(file.exists(Main_Dir))){dir.create(Main_Dir)}
	setwd(paste(getwd(),"/",Main_Dir,sep=""))
	#Create data folder
	Data_Dir <- paste(getwd(),"/Data",sep="")
	if(!(file.exists(Data_Dir))){dir.create(Data_Dir)}
	#Create data download folder
	Data_Dir <- paste(getwd(),"/Data/Data_Download",sep="")
	if(!(file.exists(Data_Dir))){dir.create(Data_Dir)}
```

####Set up vectors for use below
Set up a few vectors for working through the for loop where data is downloaded from NHTSA's FTP site.  We do this because some years of data use a four-digit value for the year while some use a two-digit.  The code accounts for this by specifying the year name using the YearsSub we create here.

```{r}
	#Create years vector
	Years. <- c(1975:2016)
	#Make a copy 
	YearsSub. <-  Years. 
	names(YearsSub.) <- c(1975:1993, sprintf("%02d",c(94:99,00,2001:2016)))
	#Create a vector to file names to convert to for storage below
	Storage_Names. <- c("acc","per","veh","accident","person","vehicle")
	names(Storage_Names.) <- rep(c("accident","person","vehicle"),2)
```	
###Download Data
Initiate and run through each year specified above to download the accident, person, and vehicle files for those years and store a local copy.  Make sure you have write permission to the drive you specified above.

####Why all the if() loops below?
FARS Datas goes back over 40 years and some years of data were stored differently than others.  A unified data base for all years doesn't exist, so we have to make our code flexible and build it ourselves.    

The code below uses the download.file() function and a specified URL to download a .zip file, open it, format the .dbf files, then stores them locally as an .RData file.  

The URL varies by year.  For example for the 1975 data the URL is:<br>
ftp://ftp.nhtsa.dot.gov/FARS/1975/DBF/FARS1975.zip

whereas for the 2012 data the URL is:<br>
ftp://ftp.nhtsa.dot.gov/FARS/2012/National/DBF/FARS2012.zip

 NHTSA makes it harder than it needs to be, but we can handle it.  


```{r}
	#Create years vector
	Years. <- c(1975:2016)
	#Make a copy 
	YearsSub. <-  Years. 
	names(YearsSub.) <- c(1975:1993, sprintf("%02d",c(94:99,00,2001:2016)))
	#Create a vector to file names to convert to for storage below
	Storage_Names. <- c("acc","per","veh","accident","person","vehicle")
	names(Storage_Names.) <- rep(c("accident","person","vehicle"),2)
	
	for(year in Years.){
		#Only do if file not already downloaded - 
		if(!(file.exists(paste(getwd(),"/Data/Data_Download/",year, sep = "")))){
			#Create yearly directory
			dir.create(paste(getwd(),"/Data/Data_Download/",year, sep = ""))
			#Create temporary file to store downloaded zip
			if(!(file.exists(paste(getwd(),"/Data/Temp",sep="")))){dir.create(paste(getwd(),"/Data/Temp",sep=""))}
			#temp <- paste(getwd(),"/Data/Temp",sep="")
			#temp <- "G:/Temp"
			temp <- paste(getwd(),"Temp",sep="")
			#Get zip files---
			#If data is between 1975-1993******
			if(year%in%c(1975:1993)){		
				download.file(paste("ftp://ftp.nhtsa.dot.gov/fars/",year,"/DBF/FARS",names(YearsSub.)[YearsSub.%in%year],".zip",sep=""),temp)
			}
			#If data is between 1993-2000*******
			if(year%in%c(1993:2000)){
				download.file(paste("ftp://ftp.nhtsa.dot.gov/fars/",year,"/DBF/FARSDBF",names(YearsSub.)[YearsSub.%in%year],".zip",sep=""),destfile = temp)
			}			
			#If data is between 2001-2013*******
			if(year%in%c(2000:2011)){
				#download.file(paste("ftp://ftp.nhtsa.dot.gov/fars/",year,"/National/FARS",names(YearsSub.)[YearsSub.%in%year],"NationalDBF.zip",sep=""),temp)
				download.file(paste("ftp://ftp.nhtsa.dot.gov/fars/",year,"/DBF/FARS",names(YearsSub.)[YearsSub.%in%year],".zip",sep=""),temp)
			}				
			if(year%in%c(2012:2016)){
				download.file(paste("ftp://ftp.nhtsa.dot.gov/fars/",year,"/National/DBF/FARS",names(YearsSub.)[YearsSub.%in%year],".zip",sep=""),temp)
			}				
			#Determine .dbf names to extract since they vary from year to year
			ZipFiles. <- unzip(temp, ,list = TRUE)[["Name"]]
			#Load each file and convert file name to lower case since these vary by year
			for(tempfile in ZipFiles.){
				Temp.. <- read.dbf(unzip(temp, files = paste(tempfile,"",sep=""),exdir = paste(getwd(),"/Temp" ,sep="")))
			}	
			#Convert all files names to lower case
			#Define in and out file paths
			From_Path  <- paste(getwd(),"/Temp",sep="")
			file.rename(from = file.path(From_Path,list.files(From_Path)),to = file.path(From_Path,tolower(list.files(From_Path)) ))
						
			#Find names of unzipped and renamed files
			Files. <- list.files(From_Path)
			#Remove numeric values from file name
			Files. <- gsub("[0-9]","",Files.)
			TempFileName <- agrep("veh",Files.,value = T)
			if(length(TempFileName ) > 1){
				TempFileName <- agrep("vehicle",Files.,value = T)
			}
			if(nchar(TempFileName) < 11){
				File_Names. <- paste(c( "acc", "per", "veh"),year,sep="")
			} else {
				File_Names. <-  tolower(c("ACCIDENT","PERSON","VEHICLE"))
			}
			rm(TempFileName)
			for(filename in File_Names.){
				#Load as table
				TempData.. <- read.dbf(paste(From_Path,"/",filename,".dbf",sep=""),as.is = TRUE)
				#Assign appropriate names for storing data below
				SaveName <- names(Storage_Names.)[Storage_Names.%in%gsub("[0-9]","",filename)]
				#Save out as R objects
				save(TempData..,file = paste(getwd(),"/Data/Data_Download/",year,"/",(SaveName),".RData",sep=""))
				#Clean up work space to avoid the wrong data getting placed in download directories
				rm(TempData..)
				file.remove(paste(From_Path,"/",filename,".dbf",sep=""))
				#Provide user feedback
				print(paste(filename, " Done", sep =""))
			#End File Type loop
			}
			#Remove files from temp folder
			file.remove(paste(From_Path,list.files(From_Path),sep=""))
			#Remove all files from temp2 directory 
			names(YearsSub.)[YearsSub.%in%year]
			#Provide user feedback
			print(paste(year, " Done", sep =""))
		#End if file present loop
		}
	#End year loop
	}

```