---
title: "Load, Prepare, and Analyze FARS Data"
author: "Josh Roll - Oregon Department of Transportation (ODOT)"
email: josh.f.roll@odot.state.or.us
output: html_document
width: 99999
---

##Introduction
Now that we have FARS data stored locally in .RData format, we can more easily utilize it for answering questions about changes in fatal traffic injuries.

But we first have to process each year of data and pull out the variables we are interested in analyzing.  Some variables have changed over the years and so we must account for that in our code so that the resulting data is consistent and easily analyzed.  

```{r}
##Load libraries
	library(reshape2)
	library(tidycensus)
	suppressWarnings(library(knitr))
```

###Set working directory
```{r}  
  #Choose the directory manually through windows explorer
#choose.dir()
#Ore set is within the code
	setwd("F:/Data/FARS")
#Set the root directory as the user sets above 
opts_knit$set(root.dir = getwd()) 
```




###Create functions
We define two custom functions below to that make loading .RData files a little simpler and another that reformats column names

```{r}
	#Function that simplifies loading .RData objects
	assignLoad <- function(filename){
       load(filename)
       get(ls()[ls() != "filename"])
    }
	#Function that changes column headers to lower case except for first letter
	toProperName <- function(X){
		EndX <- nchar(X)
	    paste(toupper(substring(X, 1, 1)), tolower(substring(X, 2, EndX)), sep="")
     }
```

	
	 
###Define work space variables and vectors
To simply some items below, we will create some vectors including one for the years of our analysis and another for US state names.  

```{r}
	#Create years vector
	Years. <- as.character(c(1975:2016))
	#Create a vector of state names - add comment
	States. <- unique(fips_codes$state_name)[c(1:51,55)]
	
	#Create vector of codes for cities in CLMPO
	#MpoCodes. <- c("350","660","1960")
	#names(MpoCodes.) <- c("Coburg","Eugene","Springfield")
	#
	
```		
	
###Process and Prepare Data 
Currently we have 40+ years of data (1975-2016) all stored in separate directories.  Each year of data is not in same format so we have to pick out data of interest and compile into a single data set for anlaysis below.  

The below for() loop loads each accident and person file for each year, and summarizes in the All_Fatal_Data.. data frame for each state, the following measures:

* Total Fatal Injuries 
* Total Alcohol Involved Fatal Injuries 
* Total Pedestrian Fatal Injuries 
* Total Intoxicated Pedestrian Fatal Injuries

```{r}
#Define data frames to store processed data below
	All_Fatal_Data.. <- data.frame()
	
	#Use for loop to cycle through each year of data
	for(year in Years.){
		#Define flags since they change by year
		#+++++++++++++++++++++++++++++++++++++++
		#BAC levels - Set a default for years 1975 - 2014
		Bac_Levels. <- c(0,94);
		Drunk_Level <- 80
		#Alcohol test 
		#Determine for years 1975 - 1990
		if(year%in%as.character(1975:1990)){
			Alcohol_Flag <- "Test_res"}
		#Determine for years 1991 - 2016	
		if(year%in%as.character(1991:2016)){
			Alcohol_Flag <- "Alc_res";}
		#Set BAC and Drunk level for years 2015 - 2016	
		if(year%in%as.character(2015:2016)){
			Bac_Levels. <- c(0,940);
			Drunk_Level <- 800}
		#Pedestrian Flag
		if(year%in%as.character(1975:1981)){Ped_Flag <- "3"}
		if(year%in%as.character(1982:2016)){Ped_Flag <- "5"}

		#Load data
		#++++++++++++++++++++++++++++++++++++++++++++++++
		Accident.. <- assignLoad(file = paste(getwd(),"/","Data/Data_Download/",year,"/accident.RDATA",sep=""))
		Person.. <- assignLoad(file = paste(getwd(),"/","Data/Data_Download/",year,"/person.RDATA",sep=""))
		#Format data
		colnames(Accident..) <- toProperName(colnames(Accident..))
		colnames(Person..) <- toProperName(colnames(Person..))
		
		#Prepare Data
		#++++++++++++++++++++++++++
		#Add geographic descriptives to Accident data---
		#Reform State variable to character and add leading zero if necessary
		Accident..$State <- sprintf("%02d",Accident..$State)
		#Add state names from tidycensus package
		Accident..$State_desc <- fips_codes$state_name[match(Accident..$State, fips_codes$state_code)]
		#Reform County variable to character and add leading zero if necessary
		Accident..$County <- sprintf("%03d",Accident..$County)
		#Add county names from tidycensus package
		Accident..$County_desc <- fips_codes$county[match(Accident..$County, fips_codes$county_code)]
		
		#Add geographic descriptives to Person data---
		#Reform State variable to character and add leading zero if necessary
		Person..$State <- sprintf("%02d",Person..$State)
		#Add state names from tidycensus package
		Person..$State_desc <- fips_codes$state_name[match(Person..$State, fips_codes$state_code)]
		#Reform County variable to character and add leading zero if necessary
		Person..$County <- sprintf("%03d",Person..$County)
		#Add county names from tidycensus package
		Person..$County_desc <- fips_codes$county[match(Person..$County, fips_codes$county_code)]
				
		#All fatals--
		#By state
		Temp_State. <- tapply(Accident..$Fatals, list(Accident..$State_desc) , sum)
		#Craft data frame and Store (State data frame created for first time)
		State_Fatal.. <- data.frame("State" = names(Temp_State.), Year = year, "Count" = Temp_State., "Measure" = "All Fatals")
			
		#All alcohol involved fatals---
		#Determine Number fatalities alcohol was involved (Use 'police reported drinking involved' and measure greater than 0) ---
		Alc_Inv.. <- Person..[Person..$Drinking%in%1 | (Person..[,Alcohol_Flag] > Bac_Levels.[1] & Person..[,Alcohol_Flag]  <= Bac_Levels.[2]),]
		#Select only fatal injuries (fatal injury == 4)
		Alc_Inv.. <- Alc_Inv..[Alc_Inv..$Inj_sev%in%4,]
		#Sum by state 
		Temp_State. <- tapply(Alc_Inv..$Inj_sev, list(Alc_Inv..$State_desc) , length)
		#Craft data frame and Store with existing 
		State_Fatal.. <- rbind(State_Fatal..,data.frame("State" = names(Temp_State.), Year = year, "Count" = Temp_State., "Measure" = "Alcohol Involved Fatals"))
		
		#Pedestrian fatalities---
		#Determine person records that are pedestrians
		Ped_Fatals.. <- Person..[Person..$Per_typ%in%Ped_Flag,]
		#Select only fatal injuries (fatal injury == 4)
		Ped_Fatals.. <- Ped_Fatals..[Ped_Fatals..$Inj_sev%in%4,]
		#Sum by state 
		Temp_State. <- tapply(Ped_Fatals..$Inj_sev, list(Ped_Fatals..$State_desc) , length)
		#Craft data frame and Store
		State_Fatal.. <- rbind(State_Fatal..,data.frame("State" = names(Temp_State.), Year = year, "Count" = Temp_State., "Measure" = "Pedestrian Fatals"))
		
		#Pedestrian fatalities with BAC > 0.08 (for the pedestrian)---
		#Determine person records that are pedestrians
		Ped_Fatals.. <- Person..[Person..$Per_typ%in%Ped_Flag,]
		#Select only fatal injuries (fatal injury == 4)
		Ped_Fatals.. <- Ped_Fatals..[Ped_Fatals..$Inj_sev%in%4 & Ped_Fatals..[,Alcohol_Flag,] >= Drunk_Level,]
		#Sum by state 
		Temp_State. <- tapply(Ped_Fatals..$Inj_sev, list(Ped_Fatals..$State_desc) , length)
		#Craft data frame and Store
		State_Fatal.. <- rbind(State_Fatal..,data.frame("State" = names(Temp_State.), Year = year, "Count" = Temp_State., "Measure" = "Drunk Pedestrian Fatals"))
		
		#Process data
		#+++++++++++++++++++++++++++++++++++++
		#Calculate the proportion of total fatals that are alcohol involved
		#Create a vector for numerator
x <-  State_Fatal..$Count[State_Fatal..$Measure%in%"Alcohol Involved Fatals" ]
#Ensure naming of numerical vector		
names(x) <- State_Fatal..$State[State_Fatal..$Measure%in%"Alcohol Involved Fatals" ]
		#Order according to defined vector of states to ensure proper calculation
		x <- x[order(factor(names(x), levels=States.))]
		#Create a vector for denominator
		y <-  State_Fatal..$Count[State_Fatal..$Measure%in%"All Fatals"]
		#Ensure naming of numerical vector
		names(y) <- State_Fatal..$State[State_Fatal..$Measure%in%"All Fatals"]
		#Calculate proportion		
		Temp_State. <- x / y[names(x)]
		#Craft data frame and Store
		State_Fatal.. <- rbind(State_Fatal..,data.frame("State" = names(Temp_State.), Year = year, "Count" = Temp_State., "Measure" = "Proportion Alcohol Involved Fatals"))
		
		#Store in master data frame
		#+++++++++++++++++++++++++++++++++++
		#Add year to current State data frame 
		State_Fatal..$Year <- year
		#Store
		All_Fatal_Data.. <- rbind(All_Fatal_Data.., State_Fatal..)
				
		
	}
	
```

###Do some validations checks to make sure our processes are not creating errors
Validation source:

https://www.nhtsa.gov/press-releases/usdot-releases-2016-fatal-traffic-crash-data

```{r}

	#Total US traffic deaths - 2016
	sum(All_Fatal_Data..$Count[All_Fatal_Data..$Year%in%"2016" & All_Fatal_Data..$Measure%in%"All Fatals"])
	#Total pedestrian traffic deaths - 2016
	sum(All_Fatal_Data..$Count[All_Fatal_Data..$Year%in%"2016" & All_Fatal_Data..$Measure%in%"Pedestrian Fatals"])
	
	#Write out the resulting files into an .RData file for simple loading and analysis. 
	save(All_Fatal_Data..,file = paste(getwd(),"/Data/Processed_Data/States_All_Ped_AlcInv.RData",sep=""))
	
	
```